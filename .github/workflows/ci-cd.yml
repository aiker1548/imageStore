# ========================================
# GitHub Actions CI/CD Pipeline
# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
# ========================================

name: CI/CD Pipeline

# –¢—Ä–∏–≥–≥–µ—Ä—ã: –∫–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è workflow
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–ø—É—Å–∫–∞ –≤—Ä—É—á–Ω—É—é

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
env:
  PYTHON_VERSION: '3.10'

jobs:
  # ========================================
  # JOB 1: –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —Ä–∞–∑–Ω—ã—Ö –û–°
  # ========================================
  build-and-test:
    name: Build and Test on ${{ matrix.os }}
    
    # –ú–∞—Ç—Ä–∏—á–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è - —Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–∞ 3 –û–°
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # –®–∞–≥ 4: –õ–∏–Ω—Ç–∏–Ω–≥ –∫–æ–¥–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è)
      - name: Lint with flake8
        working-directory: ./backend
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        continue-on-error: true
      
      # –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ unit-—Ç–µ—Å—Ç–æ–≤
      - name: Run unit tests
        working-directory: ./backend
        run: |
          pytest tests/test_auth.py -v --cov=. --cov-report=term
      
      # –®–∞–≥ 6: –ó–∞–≥—Ä—É–∑–∫–∞ coverage –æ—Ç—á–µ—Ç–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è Ubuntu)
      - name: Upload coverage reports
        if: matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: unittests
        continue-on-error: true

  # ========================================
  # JOB 2: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
  # ========================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build-and-test  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    
    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # –®–∞–≥ 3: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
      - name: Build Docker image
        working-directory: ./backend
        run: |
          docker build -t imagestore-backend:latest .
          docker images
      
      # –®–∞–≥ 4: –¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      - name: Test Docker container
        run: |
          docker run -d --name test-container \
            -e DB_URL=localhost:3306 \
            -e BACKEND_URL=localhost:8000 \
            -p 8000:8000 \
            imagestore-backend:latest
          
          # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
          sleep 10
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω
          docker ps | grep test-container
          
          # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
          docker stop test-container
          docker rm test-container

  # ========================================
  # JOB 3: –°–∏–º—É–ª—è—Ü–∏—è –¥–µ–ø–ª–æ—è
  # ========================================
  deploy:
    name: Deploy to Production (Simulated)
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build-docker  # –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ Docker
    
    steps:
      # –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –°–∏–º—É–ª—è—Ü–∏—è –¥–µ–ø–ª–æ—è
      - name: Simulate deployment
        run: |
          echo "=========================================="
          echo "üöÄ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞—á–∞–ª—Å—è..."
          echo "=========================================="
          echo "‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
          echo "‚úì –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞..."
          echo "‚úì –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏..."
          echo "‚úì –ó–∞–ø—É—Å–∫ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏..."
          echo "‚úì –ü—Ä–æ–≤–µ—Ä–∫–∞ health check..."
          echo "=========================================="
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
          echo "=========================================="
          echo ""
          echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–µ–ø–ª–æ–µ:"
          echo "   - –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
          echo "   - –í–µ—Ç–∫–∞: ${{ github.ref }}"
          echo "   - –ê–≤—Ç–æ—Ä: ${{ github.actor }}"
          echo "   - –í—Ä–µ–º—è: $(date)"
      
      # –®–∞–≥ 3: –°–æ–∑–¥–∞–Ω–∏–µ Release (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Create deployment marker
        run: |
          echo "Deployment completed at $(date)" > deployment.txt
          echo "Commit: ${{ github.sha }}" >> deployment.txt
      
      # –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞ –¥–µ–ø–ª–æ—è
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment.txt

  # ========================================
  # JOB 4: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö
  # ========================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    if: always()
    needs: [build-and-test, build-docker, deploy]
    
    steps:
      - name: Check workflow status
        run: |
          echo "=========================================="
          echo "üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã CI/CD Pipeline"
          echo "=========================================="
          echo "Build and Test: ${{ needs.build-and-test.result }}"
          echo "Build Docker: ${{ needs.build-docker.result }}"
          echo "Deploy: ${{ needs.deploy.result }}"
          echo "=========================================="
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å
          if [ "${{ needs.build-and-test.result }}" == "success" ] && \
             [ "${{ needs.build-docker.result }}" == "success" ]; then
            echo "‚úÖ CI/CD Pipeline –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
            exit 0
          else
            echo "‚ùå CI/CD Pipeline –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–∞–º–∏"
            exit 1
          fi

# ========================================
# –û–ü–ò–°–ê–ù–ò–ï –î–ñ–û–ë–û–í:
#
# 1. build-and-test:
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞: Linux, Windows, MacOS
#    - –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
#    - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–æ–º (flake8)
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
#    - GitHub Actions: checkout@v4, setup-python@v5, codecov@v4
#
# 2. build-docker:
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
#    - –°–æ–±–∏—Ä–∞–µ—Ç Docker –æ–±—Ä–∞–∑
#    - –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
#    - GitHub Actions: checkout@v4, setup-buildx-action@v3
#
# 3. deploy:
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ push –≤ main
#    - –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å–ø–µ—à–Ω–æ–π —Å–±–æ—Ä–∫–∏ Docker
#    - –°–ò–ú–£–õ–ò–†–£–ï–¢ –¥–µ–ø–ª–æ–π (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞)
#    - –°–æ–∑–¥–∞–µ—Ç –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –¥–µ–ø–ª–æ–µ
#    - GitHub Actions: checkout@v4, upload-artifact@v4
#
# 4. notify:
#    - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Å–µ–≥–¥–∞ (–¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
#    - –í—ã–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—Å–µ—Ö –¥–∂–æ–±–æ–≤
#    - –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å –ø–∞–π–ø–ª–∞–π–Ω–∞
#
# –¢–†–ò–ì–ì–ï–†–´:
# - push –≤ –≤–µ—Ç–∫–∏ main/master
# - pull_request –≤ –≤–µ—Ç–∫–∏ main/master
# - workflow_dispatch (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
#
# –ó–ê–í–ò–°–ò–ú–û–°–¢–ò –ú–ï–ñ–î–£ –î–ñ–û–ë–ê–ú–ò:
# build-and-test ‚Üí build-docker ‚Üí deploy ‚Üí notify
# ========================================